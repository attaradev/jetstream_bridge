name: restrictive

services:
  # NATS JetStream Server
  nats:
    image: nats:2.10-alpine
    ports:
      - "5222:4222" # shifted to avoid clashing with non-restrictive example
      - "8822:8222"
    command: [
      "--jetstream",
      "--store_dir=/data",
      "--http_port=8222"
    ]
    volumes:
      - nats_data_restrictive:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - restrictive_network

  # PostgreSQL for System A
  postgres_a:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: system_a_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "65432:5432" # avoid host port clash with local Postgres and other example
    volumes:
      - postgres_a_data_restrictive:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - restrictive_network

  # PostgreSQL for System B
  postgres_b:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: system_b_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "65433:5432" # avoid host port clash with local Postgres and other example
    volumes:
      - postgres_b_data_restrictive:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - restrictive_network

  # Provisioner - Runs ONCE to create streams/consumers
  # This simulates an admin process with elevated permissions
  # that pre-provisions the NATS topology before apps start
  provisioner:
    build:
      context: ../../
      dockerfile: examples/restrictive/provisioner/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      STREAM_NAME: sync-stream
      CONSUMER_MODE: ${CONSUMER_MODE:-pull}
    depends_on:
      nats:
        condition: service_healthy
    networks:
      - restrictive_network
    restart: "no"  # Run once and exit

  # System A - Web (Rails API)
  # Starts AFTER provisioner completes
  system_a:
    build:
      context: ../../
      dockerfile: examples/restrictive/Dockerfile.system_a
    ports:
      - "3100:3000" # shifted to avoid clashing with non-restrictive example
    environment:
      RAILS_ENV: development
      DB_HOST: postgres_a
      DB_PORT: 5432
      DB_NAME: system_a_development
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      NATS_URL: nats://nats:4222
      STREAM_NAME: sync-stream
      CONSUMER_MODE: ${CONSUMER_MODE:-pull}
      PORT: 3000
    depends_on:
      nats:
        condition: service_healthy
      postgres_a:
        condition: service_healthy
      provisioner:
        condition: service_completed_successfully
    networks:
      - restrictive_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    command: >
      sh -c "
        wait-for-db.sh bundle exec rake db:create db:migrate &&
        bundle exec puma -C config/puma.rb
      "

  # System A - Consumer Process (bidirectional sync)
  # Starts AFTER provisioner completes
  system_a_consumer:
    build:
      context: ../../
      dockerfile: examples/restrictive/Dockerfile.system_a
    environment:
      RAILS_ENV: development
      DB_HOST: postgres_a
      DB_PORT: 5432
      DB_NAME: system_a_development
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      NATS_URL: nats://nats:4222
      STREAM_NAME: sync-stream
      CONSUMER_MODE: ${CONSUMER_MODE:-pull}
    depends_on:
      nats:
        condition: service_healthy
      postgres_a:
        condition: service_healthy
      provisioner:
        condition: service_completed_successfully
      system_a:
        condition: service_healthy
    networks:
      - restrictive_network
    command: >
      sh -c "
        wait-for-db.sh bundle exec ruby bin/consumer
      "

  # System B - Web (Rails API)
  # Starts AFTER provisioner completes
  system_b_web:
    build:
      context: ../../
      dockerfile: examples/restrictive/Dockerfile.system_b
    ports:
      - "3101:3001" # shifted to avoid clashing with non-restrictive example
    environment:
      RAILS_ENV: development
      DB_HOST: postgres_b
      DB_PORT: 5432
      DB_NAME: system_b_development
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      NATS_URL: nats://nats:4222
      STREAM_NAME: sync-stream
      CONSUMER_MODE: ${CONSUMER_MODE:-pull}
      PORT: 3001
    depends_on:
      nats:
        condition: service_healthy
      postgres_b:
        condition: service_healthy
      provisioner:
        condition: service_completed_successfully
      system_a:
        condition: service_healthy
    networks:
      - restrictive_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    command: >
      sh -c "
        wait-for-db.sh bundle exec rake db:create db:migrate &&
        bundle exec puma -C config/puma.rb
      "

  # System B - Consumer Process
  # Starts AFTER provisioner completes
  system_b_consumer:
    build:
      context: ../../
      dockerfile: examples/restrictive/Dockerfile.system_b
    environment:
      RAILS_ENV: development
      DB_HOST: postgres_b
      DB_PORT: 5432
      DB_NAME: system_b_development
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      NATS_URL: nats://nats:4222
      STREAM_NAME: sync-stream
      CONSUMER_MODE: ${CONSUMER_MODE:-pull}
    depends_on:
      nats:
        condition: service_healthy
      postgres_b:
        condition: service_healthy
      provisioner:
        condition: service_completed_successfully
      system_b_web:
        condition: service_healthy
    networks:
      - restrictive_network
    command: >
      sh -c "
        wait-for-db.sh bundle exec ruby bin/consumer
      "

networks:
  restrictive_network:
    driver: bridge

volumes:
  nats_data_restrictive:
  postgres_a_data_restrictive:
  postgres_b_data_restrictive:
