# frozen_string_literal: true

class CreateJetstreamInboxEvents < ActiveRecord::Migration[7.0]
  def change
    create_table :jetstream_inbox_events do |t|
      t.string   :event_id                              # preferred dedupe key
      t.string   :subject,     null: false
      t.jsonb    :payload,     null: false, default: {}
      t.jsonb    :headers,     null: false, default: {}
      t.string   :stream
      t.bigint   :stream_seq
      t.integer  :deliveries
      t.string   :status,      null: false, default: 'received' # received|processing|processed|failed
      t.text     :last_error
      t.datetime :received_at
      t.datetime :processed_at
      t.timestamps
    end

    add_index :jetstream_inbox_events, :event_id, unique: true, where: 'event_id IS NOT NULL'
    add_index :jetstream_inbox_events, [:stream, :stream_seq], unique: true, where: 'stream IS NOT NULL AND stream_seq IS NOT NULL'
    add_index :jetstream_inbox_events, :status
  end
end
